# 堆叠示例

**简体中文** | [English](README.md)

演示 `base` + `opencode` 配置的层次堆叠。

## 堆叠层次

```
┌─────────────────────────────────────────────────────────┐
│  第 3 层：你的项目                                       │
│  └── ./          覆盖: memory 2g, ports 9000:9000       │
└─────────────────────────────────────────────────────────┘
                         ▲ 合并
┌─────────────────────────────────────────────────────────┐
│  第 2 层：opencode/      卷、环境变量                    │
└─────────────────────────────────────────────────────────┘
                         ▲ 基于
┌─────────────────────────────────────────────────────────┐
│  第 1 层：base/          安全、资源、日志                │
└─────────────────────────────────────────────────────────┘
```

## 快速开始

```bash
# 运行演示
cd examples/stacked-example
./demo.sh
```

或手动执行：

```bash
# 查看合并后的 docker 命令
cd examples/stacked-example
nix-devbox run ../base ../opencode . --dry-run

# 使用所有层运行
nix-devbox run ../base ../opencode . -- nix develop
```

## 合并效果

| 配置 | 来源 | 结果 |
|------|------|------|
| memory | base: 1g → local: 2g | **2g** |
| cpus | base: 2.0 | **2.0** (继承) |
| cap_drop | base: ALL | **ALL** (继承) |
| volumes | opencode: 3 个挂载 | **3 个挂载** (继承) |
| env | opencode: 2 个变量 | **2 个变量** (继承) |
| ports | local: 9000:9000 | **9000:9000** (新增) |

## 文件

- `devbox.yaml` - 覆盖内存，添加端口
- `demo.sh` - 运行查看堆叠效果
